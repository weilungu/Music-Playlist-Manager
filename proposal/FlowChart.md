# 音樂播放清單管理器 — 標準流程圖（Mermaid）

以下提供三個統一風格的標準流程圖，使用 Mermaid 流程圖語法，分別涵蓋：
- 系統生命周期與初始化
- 播放控制與播放清單操作
- 資料持久化與搜尋索引

> 若 VS Code 或你的 Markdown Preview 未啟用 Mermaid，請安裝支援外掛或改用 GitHub/Obsidian 等支援 Mermaid 的預覽器。

---

## 系統生命周期與初始化

```mermaid
flowchart TD
    Start([開始]) --> A[載入 index.html]
    A --> B[初始化 IndexedDB]
    B --> C[讀取 localStorage\n- 播放清單\n- 排序設定]
    C --> D[載入 IndexedDB 音訊檔案]
    D --> E[初始化資料結構]
    
    subgraph "資料結構初始化"
        E --> E1["Doubly Linked List\n(播放清單雙向遍歷)"]
        E --> E2["Queue\n(待播放佇列 FIFO)"]
        E --> E3["HashTable\n(O(1) 快速搜尋)"]
        E --> E4["BinarySearchTree\n(O(log n) 排序查詢)"]
    end
    
    E1 --> F[初始化控制器\n- PlayerController\n- PlaylistController]
    E2 --> F
    E3 --> F
    E4 --> F
    F --> G[綁定 UI 事件監聽器]
    G --> H{使用者操作?}
    H -->|是| I[更新狀態 / 觸發對應流程]
    I --> H
    H -->|結束| End([結束])
```

---

## 播放控制與播放清單操作

```mermaid
flowchart TD
    Start([開始]) --> P1
    
    subgraph "Playlist Operations 播放清單操作"
        P1[新增歌曲] --> P2[驗證歌曲資料]
        P2 -->|成功| P3["建立 Song 物件"]
        P3 --> P4["插入 Doubly Linked List\n(O(1) 頭尾插入)"]
        P4 --> P5["插入 BinarySearchTree\n(O(log n) 排序插入)"]
        P5 --> P6["更新 HashTable 搜尋索引\n(O(1) 雜湊插入)"]
        P6 --> P7[儲存至 localStorage]
        P7 --> P8{是否有音訊檔?}
        P8 -->|是| P9["File -> Base64 -> IndexedDB"]
        P8 -->|否| P10[跳過檔案儲存]
    end

    subgraph "Player Control 播放器控制"
        C1["Play/Pause"] --> C2[更新 UI 播放狀態]
        C3["Prev (上一首)"] --> C4["Doubly Linked List\nprev 指標遍歷"]
        C5["Next (下一首)"] --> C6["Doubly Linked List\nnext 指標遍歷"]
        C7[Shuffle 隨機播放] --> C8["Fisher-Yates 洗牌演算法"]
        C4 --> C9[載入目標歌曲]
        C6 --> C9
        C8 --> C9
        C9 --> C10["播放音訊 (Audio API)"]
        C10 --> C11["更新時間軸 / 顯示資訊"]
    end

    subgraph "Queue 待播放佇列"
        Q1["enqueue 加入佇列\n(O(1))"]
        Q2["dequeue 取出播放\n(O(1) FIFO)"]
        Q1 --> Q2
    end

    P10 --> End([結束])
    C11 --> End
    P4 -. 資料來源 .-> C4
    P4 -. 資料來源 .-> C6
    Q2 -. 下一首來源 .-> C9
```

---

## 資料持久化與搜尋索引

```mermaid
flowchart TB
    Start([開始]) --> U1[使用者操作]
    
    subgraph "Storage 儲存層"
        S1[播放清單 JSON]
        S2[IndexedDB 音訊塊]
        S3[SearchIndex Map]
    end

    subgraph "Data Structures 資料結構"
        DS1["Doubly Linked List\n- 雙向遍歷播放清單\n- O(1) 插入/刪除"]
        DS2["Queue\n- FIFO 待播放佇列\n- O(1) enqueue/dequeue"]
        DS3["HashTable\n- 快速關鍵字搜尋\n- O(1) 平均查詢"]
        DS4["BinarySearchTree\n- 歌曲排序索引\n- O(log n) 查詢/插入"]
    end

    subgraph "Algorithms 演算法"
        AL1["In-order Traversal\n(BST 中序遍歷排序)"]
        AL2["Fisher-Yates Shuffle\n(隨機播放洗牌)"]
        AL3["Hash Function\n(字串雜湊計算)"]
    end

    U1 --> U2{需要更新資料?}
    U2 -->|是| W1[序列化播放清單 -> localStorage]
    U2 -->|是| W2[音訊檔 Base64 -> IndexedDB]
    U2 -->|是| W3[重建/更新搜尋索引]
    W1 --> W4{完成?}
    W2 --> W4
    W3 --> W4
    U2 -->|否| U1
    W4 -->|是| End([結束])

    subgraph "Reload 重新載入"
        R1[應用刷新] --> R2[讀取 localStorage]
        R2 --> R3[讀取 IndexedDB]
        R3 --> R4["重建資料結構\n(DLL, Queue, HashTable, BST)"]
    end

    S1 -. 來源 .- R2
    S2 -. 來源 .- R3
    DS3 -. 使用 .- AL3
    DS4 -. 使用 .- AL1
```

---

### 備註
- 三張圖採用一致節點命名與方向配置，便於閱讀與維護。
- Mermaid 流程圖可在多數 Markdown 平台直接渲染；如需匯出圖片，可使用 Mermaid CLI 或擴充套件。

## 🎵 播放系統流程圖

```
                    ┌─────────────────────┐
                    │   播放列表管理      │
                    └──────────┬──────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
        ▼                      ▼                      ▼
   ┌─────────────┐      ┌──────────────┐      ┌──────────────┐
   │ 新增歌曲    │      │ 刪除歌曲     │      │ 搜尋歌曲     │
   │ (add)       │      │ (remove)     │      │ (search)     │
   └─────────────┘      └──────────────┘      └──────────────┘
        │                      │                      │
        ▼                      ▼                      ▼
   ┌─────────────┐      ┌──────────────┐      ┌──────────────┐
   │ 驗證歌曲    │      │ 驗證存在     │      │ 雜湊表查詢   │
   │ 物件        │      │              │      │ (O(1))       │
   └─────────────┘      └──────────────┘      └──────────────┘
        │                      │                      │
        ▼                      ▼                      ▼
   ┌─────────────────────────────────────────────────────┐
   │         更新播放列表 (LinkedList)                   │
   │    更新搜尋索引 & 儲存到 localStorage/IndexedDB    │
   └─────────────────────────────────────────────────────┘
```

---

## 🎚️ 播放控制流程圖

```
                    ┌──────────────────┐
                    │  播放器控制      │
                    └────────┬─────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
   ┌─────────────┐      ┌──────────────┐    ┌──────────────┐
   │ 播放/暫停   │      │ 上一首/下一首│    │ 隨機播放     │
   │ (play/pause)│      │ (prev/next)  │    │ (shuffle)    │
   └──────┬──────┘      └───────┬──────┘    └───────┬──────┘
          │                     │                   │
          │        ┌────────────┴────────────┐      │
          │        │                        │      │
          ▼        ▼                        ▼      ▼
    ┌─────────────────────────────────────────────────┐
    │   更新當前播放索引 (currentIndex)               │
    │   獲取當前歌曲資訊                             │
    │   播放音訊檔案 (Audio API)                     │
    │   更新 UI 顯示歌曲資訊                         │
    └─────────────────────────────────────────────────┘
```

---

## 💾 資料存儲流程圖

```
                    ┌──────────────────────┐
                    │   資料持久化系統     │
                    └──────────┬───────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
        ▼                      ▼                      ▼
   ┌───────────────────┐  ┌──────────────┐  ┌──────────────────┐
   │  localStorage     │  │  IndexedDB   │  │ 搜尋索引         │
   │  (播放清單)       │  │  (音訊檔案)  │  │ (SearchIndex)    │
   └────────┬──────────┘  └──────┬───────┘  └────────┬─────────┘
            │                    │                   │
            ▼                    ▼                   ▼
     ┌─────────────────┐  ┌─────────────┐   ┌─────────────┐
     │ JSON 序列化     │  │ Base64      │   │ 更新文藝索引│
     │ 存儲/讀取       │  │ 編碼        │   │             │
     └─────────────────┘  └─────────────┘   └─────────────┘
            │                    │                   │
            └────────────────────┼───────────────────┘
                                 │
                    ┌────────────▼──────────┐
                    │  應用程式刷新時      │
                    │  自動載入資料        │
                    └───────────────────────┘
```

---

## 🔍 資料結構使用流程圖

```
                    ┌─────────────────────┐
                    │   播放清單資料結構  │
                    └──────────┬──────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
        ▼                      ▼                      ▼
   ┌────────────┐         ┌────────────┐       ┌─────────────┐
   │LinkedList  │         │HashTable   │       │BinarySearchTree
   │(主播放清單)│         │(搜尋索引)  │       │(排序/查詢)  │
   │ O(1) insert│         │ O(1)lookup │       │ O(logn)     │
   │ O(n) delete│         │ O(1) add   │       │             │
   │ O(n) search│         │            │       │             │
   └────────────┘         └────────────┘       └─────────────┘
        │
        │  (可選)
        ▼
   ┌────────────┐
   │Queue       │
   │(即將播放)  │
   │ O(1)enqueue│
   │ O(1)dequeue│
   └────────────┘
```

---

## 🔄 控制器互動流程圖

```
              ┌─────────────────────────────────┐
              │    UI 事件觸發 (點擊/輸入)      │
              └────────────┬────────────────────┘
                           │
        ┌──────────────────┴──────────────────┐
        │                                     │
        ▼                                     ▼
    ┌─────────────────┐                ┌──────────────┐
    │ PlayerController│                │PlaylistController
    │ (播放器邏輯)    │                │ (播放清單邏輯)
    └────────┬────────┘                └────────┬─────┘
             │                                  │
   ┌─────────┴──────────┬─────────────┬────────┴─────┐
   │                    │             │              │
   ▼                    ▼             ▼              ▼
Play/Pause        Previous/Next    Add Song    Remove Song
Update Status     Shuffle Mode     Validate    Update Index
Update Time       Update Display   Save to DB  Update UI
UI Display        Current Index              Search/Sort
```

---

## 🚀 應用程式生命周期流程圖

```
┌────────────────────────────────────────────────────────┐
│           使用者載入 index.html                        │
└────────────────┬─────────────────────────────────────┘
                 │
                 ▼
     ┌─────────────────────────────┐
     │ 1. 初始化 IndexedDB         │
     └────────────┬────────────────┘
                  │
                  ▼
     ┌─────────────────────────────┐
     │ 2. 從 localStorage 載入     │
     │    - 播放清單               │
     │    - 排序設定               │
     └────────────┬────────────────┘
                  │
                  ▼
     ┌─────────────────────────────┐
     │ 3. 從 IndexedDB 載入        │
     │    - 音訊檔案               │
     └────────────┬────────────────┘
                  │
                  ▼
     ┌─────────────────────────────┐
     │ 4. 重建搜尋索引             │
     │    (SearchIndexMap)         │
     └────────────┬────────────────┘
                  │
                  ▼
     ┌─────────────────────────────┐
     │ 5. 初始化控制器             │
     │    - PlayerController       │
     │    - PlaylistController     │
     └────────────┬────────────────┘
                  │
                  ▼
     ┌─────────────────────────────┐
     │ 6. 綁定 UI 事件監聽器       │
     └────────────┬────────────────┘
                  │
                  ▼
     ┌─────────────────────────────┐
     │ 7. 應用程式準備完成         │
     │    等待使用者操作           │
     └─────────────────────────────┘
```

---

## 📝 新增歌曲詳細流程

```
使用者填寫表單並提交
        │
        ▼
驗證歌曲資訊 (title, artist, duration)
        │
        ├─驗證失敗 ──→ 顯示錯誤訊息
        │
        ├─驗證成功
        │
        ▼
建立 Song 物件
        │
        ▼
產生歌曲唯一鍵 (songKey)
        │
        ▼
新增到 LinkedList (播放清單)
        │
        ▼
新增到 HashTable (搜尋索引)
        │
        ▼
若有上傳音訊檔案
        │
        ├─轉換為 Base64
        │
        ├─儲存到 IndexedDB
        │
        └─記錄索引
        │
        ▼
儲存到 localStorage
        │
        ▼
更新 UI 顯示
        │
        ▼
清空表單
```

---

## 🔎 搜尋歌曲流程

```
使用者輸入搜尋關鍵字
        │
        ▼
驗證搜尋字符 (不為空)
        │
        ├─為空 ──→ 顯示全部歌曲
        │
        ├─不為空
        │
        ▼
使用 HashTable 查詢 (O(1))
        │
        ├─查詢 by 曲名
        ├─查詢 by 歌手
        ├─查詢 by 組合
        │
        ▼
返回符合結果
        │
        ▼
更新搜尋結果顯示區域
        │
        ▼
允許使用者選擇並播放結果歌曲
```

---

## 📊 資料轉換流程

```
                    ┌──────────────────┐
                    │   檔案轉換系統   │
                    └────────┬─────────┘
                             │
        ┌────────────────────┼─────────────────────┐
        │                    │                     │
        ▼                    ▼                     ▼
   ┌─────────┐          ┌────────┐           ┌────────────┐
   │ 檔案輸入 │          │ 歌曲   │           │ JSON 資料  │
   │ (Music) │          │ 物件   │           │ (播放清單) │
   └────┬────┘          └───┬────┘           └─────┬──────┘
        │                   │                      │
        ▼                   ▼                      ▼
   ┌─────────────┐     ┌──────────┐          ┌──────────────┐
   │ FileReader  │     │ Song     │          │ JSON.stringify
   │ readAsArray │     │ (model)  │          │              │
   │ Buffer      │     │          │          │              │
   └─────┬───────┘     └──────────┘          └──────┬───────┘
         │                                          │
         ▼                                          ▼
    ┌────────────┐                             ┌─────────────┐
    │ Base64     │                             │ localStorage
    │ encode     │                             │ 字符串      │
    └─────┬──────┘                             └──────┬──────┘
          │                                           │
          ▼                                           ▼
    ┌────────────────┐                         ┌─────────────┐
    │ IndexedDB      │                         │ 重新加載時  │
    │ 儲存區塊       │                         │ JSON.parse  │
    └────────────────┘                         └─────────────┘
```

---

## 🎯 使用者互動決策樹

```
                    使用者打開應用
                          │
              ┌───────────┼───────────┐
              │           │           │
              ▼           ▼           ▼
          播放歌曲    管理播放清單   搜尋歌曲
              │           │           │
        ┌─────┴─────┐     │      ┌────┴─────┐
        │           │     │      │          │
        ▼           ▼     ▼      ▼          ▼
      播放     隨機播放  新增   刪除      by曲名  by歌手
        │           │    歌曲   歌曲        │       │
        ├─操作播放  │     │      │          │       │
        │ 按鈕      │     │      │      ┌───┴───┬───┴───┐
        └─更新進度  │     │      │      │       │       │
              │     │     │      │      ▼       ▼       ▼
              └─────┴─────┴─────┴─────按Enter 查詢  合併結果
                          │
                          ▼
                  更新 UI 並保存資料
```

---

## 💡 系統特性說明

### 📌 主要功能
- ✅ 播放清單管理 (新增/刪除/搜尋)
- ✅ 音樂播放控制 (播放/暫停/上一首/下一首)
- ✅ 隨機播放功能
- ✅ 進度條顯示
- ✅ 本地資料持久化
- ✅ 音訊檔案管理

### ⚙️ 技術棧
- **前端**: HTML5, CSS3, Vanilla JavaScript
- **儲存**: localStorage (播放清單) + IndexedDB (音訊檔案)
- **資料結構**: LinkedList, HashTable, Queue, BinarySearchTree
- **API**: Web Audio API, FileReader API

### 🎯 效能優化
- LinkedList: O(1) 插入操作
- HashTable: O(1) 搜尋操作  
- BinarySearchTree: O(log n) 排序查詢
- 快取系統: 最大歌手編號、搜尋索引

